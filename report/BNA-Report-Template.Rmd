---
title: "BNA Report"
output:
  html_notebook:
    highlight: haddock
    theme: journal
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = normalizePath("../"))
knitr::read_chunk(
  "../scripts/analysis.R"
)
```

# Case Study: `r sa_name` {.tabset}

## Analysis summary

```{r database, include = FALSE}
db_name = "bna_europe"
local_host = "localhost"
port_num = 5432
user_name = "postgres"
db_pass = rstudioapi::askForPassword("Database password")
```

```{r variables, warning = FALSE, include = FALSE}
## Basic variables to set 
country = "UK" # Possible options: UK, US, Belgium, Netherlands, NA
sa_name = "Corby" # study area
sa_crs = 3857 # crs
biking_distance = 3000 ## in meters

area_type = "osm" ## possible options: "
                  ## "osm" for any country
                  ## "ttwa" for the UK

min_area = "lsoa" ## possible options: 
                  ## "geostat" for any country, 
                  ## "lsoa" or "msoa" for the UK
                  ## "cb" for the US (not yet)
                  ## "buurt" for the Netherlands

## If the analysis runs with the GEOSTAT population grid as min_area
subdivisions = 4
```

* You calculated the BNA score for 
<span style="color:#BB616D">**`r sa_name`, `r country`**</span> 
within a biking distance of 
<span style="color:#BB616D">**`r biking_distance/1000`**</span> km. 

`r ifelse(area_type == "osm",paste("The size of the osm data for your study area is", osm_size, "MB and the"),"The")` analysis took **`r round(as.numeric(duration),2)` minutes** to run.

* The analysis corresponds to the 
<span style="color:#BB616D">**`r ifelse(area_type == "ttwa","Travel to Work Area","OSM boundary area")`**</span> (red) based on 
<span style="color:#BB616D">**`r ifelse(min_area == "msoa","its Middle Layer Superoutput Areas (MSOA)",ifelse(min_area == "lsoa","its Lower Layer Superoutput Areas (LSOA)",ifelse(min_area == "cb","its census blocks",ifelse(min_area == "buurt","its neighborhood areas","a subdivided population grid from GEOSTAT"))))`**</span> (green).

```{r area, include=FALSE, cache = FALSE}
```

```{r network, include = FALSE, cache = FALSE}
```

```{r min_area, include = FALSE, cache = FALSE}
```

```{r plot_area, fig.width = 8, fig.height= 5, echo = FALSE, warning = FALSE, message = FALSE}
library(tmap)

tmap_mode("view")
tmap_leaflet(
     tm_view(
     basemaps = "CartoDB.Positron"
   ) +
     tm_shape(min_area_grid) +
     tm_polygons(
       border.col = "green",
       alpha = 0
      ) +
     tm_shape(boundary) +
     tm_polygons(
       border.col = "red",
       alpha = 0,
       lwd = 4
      ) 
)
```

```{r reachable_roads, include = FALSE, cache = FALSE}
```

```{r accessibility, include = FALSE, cache = FALSE}
```

```{r overall_score, include = FALSE, cache = FALSE}
```

## Results

```{r, include = FALSE, warning = FALSE}
## Call data into R
library(sf)
bna_score <- st_read(
  dsn = connection,
  layer = c("generated","sa_pop_grid")
)

stress_network <- st_read(
  dsn = connection,
  query = "SELECT ft_seg_stress, tf_seg_stress, geom FROM received.sa_ways"
)

## Establish colors and breaks for the BNA display based on the PfB visualizer
bna_pal <- c("#FC7151","#DC7E6A","#C98875","#C08B83","#AD9396",
             "#9C9A9F","#929EAC","#78AAC5","#6FADCB","#49BFE6")

bna_breaks <- c(6,12,18,24,30,36,42,48,54,100)

stress_network$ft_stress <- ifelse(stress_network$ft_seg_stress == 1,"low stress","high stress")
stress_network$tf_stress <- ifelse(stress_network$tf_seg_stress == 1,"low stress","high stress")

## Call plotting library and set to mode view
library(tmap)
tmap_mode("view")
```

```{r, fig.width = 10, fig.height= 5, fig.align = 'center', echo = FALSE, warning = FALSE}
int_map <- 
  tmap::tmap_leaflet(
     tmap::tm_view(
     basemaps = c(
       "CartoDB.Positron",
       "CartoDB.DarkMatter",
       "OpenStreetMap.Mapnik"
     )
   ) +
     tmap::tm_shape(bna_score) +
     tmap::tm_polygons(
       col = "overall_score",
       style = "fixed",
       breaks = bna_breaks,
       palette = bna_pal,
       alpha = 0.8,
       title = "BNA score",
       border.col = NULL,
       colorNA = NULL,
       showNA = FALSE
      ) +
     tmap::tm_shape(stress_network) +
     tmap::tm_lines(
       col = "ft_stress", 
       colorNA = NULL,
       showNA = FALSE,
       palette = c("firebrick1", "deepskyblue3"),
       title.col = "Stress network"
      ) +
     tmap::tm_shape(stress_network) +
     tmap::tm_lines(
       col = "tf_stress", 
       colorNA = NULL,
       showNA = FALSE,
       palette = c("firebrick1", "deepskyblue3"),
       legend.col.show = FALSE
      )
  )

int_map
```

```{r display_table, include = TRUE, echo = FALSE, cache = FALSE}
```

```{r duration, include = FALSE, cache = FALSE}
```

## Setup info

To run this analysis, the user should:

1. Create a database on its PostgreSQL. To test connection an empty table on the database called "test" should be created on the public schema. 
    + Tip: Run FULL VACUUM/ANALYZE frequently to the database to improve performance.
    + Follow the tips on [this presentation](https://thebuild.com/presentations/not-your-job.pdf) to increase performance of the database.

2. Set path variables for `osm2pgsql` and `osm2pgrouting`.

3. Create a password file on `%APPDATA%/postgresql/pgpass.conf` with the format *hostname:port:database:username:password*


## Data sources

```{r, echo = FALSE}
library(kableExtra)
tbl <- data.frame(
  Region = cell_spec(
    c(
      "US",
      "Europe",
      "UK",
      "The Netherlands"
    )
  ),
  source_pop = cell_spec(
    c(
      "",
      "GEOSTAT - EUROSTAT",
      "Office of National Statistics - UK",
      "CBS (Centraal Bureau voor de Statistiek) - NL"
    ),
    link = c(
      "",
      "https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/population-distribution-demography/geostat",
      "https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates",
      "https://www.cbs.nl/nl-nl/dossier/nederland-regionaal/geografische%20data/wijk-en-buurtkaart-2017"
    )
  ),
  desc_pop = cell_spec(
    c(
      "Not added yet.",
      "Population grid per squared kilometer for 2011.",
      "Population estimates for mid-2017 at LSOA and MSOA level.",
      "District and neighborhood map with associated key figures for 2017."
    )
  ),
  source_jobs = cell_spec(
    c(
      "",
      "",
      "Office of National Statistics - UK",
      "LISA (National Information System for Workplaces) dataset"
    ), 
    link = c(
      "",
      "",
      "https://wicid.ukdataservice.ac.uk/cider/wicid/downloads.php?guest=1",
      "https://www.lisa.nl/data/gratis-data/overzicht-lisa-data-per-gemeente"
    )
  ),
  desc_jobs = cell_spec(
    c(
      "Not added yet.",
      "No data available for the whole continent with high spatial resolution.",
      "Flow commute data for the 2011 Census at LSOA and MSOA level, where the total number of trips per super-output area where aggregated.",
      "Jobs per municipality. To estimate jobs at neighborhood level an weighted estimation was made with the number of jobs in the whole municipality hafly weighted by the fraction of the neighborhood area, and hafly weighted by the fraction of companies in the neighborhood. This approach needs to be validated, however it is one way to approximate it, given that LISA data at this aggregation level has to be bought and is not open data."
    )
  )
)

names(tbl) <- c("Region", "Source", "Description", "Source", "Description")

kable(tbl, align = "c", escape = FALSE) %>%
  kable_styling("striped", "bordered", font_size = 10, full_width = T) %>% 
  add_header_above(c(" ", "Population" = 2, "Jobs" = 2)) %>% 
  column_spec(3, width_max = "10cm") %>% 
  column_spec(5, width_max = "10cm")
```

